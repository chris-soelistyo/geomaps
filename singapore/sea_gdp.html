<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SVG Pan/Zoom â€” desktop + mobile</title>
<style>
  html, body { height:100%; margin:0; }
  #app {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #fff;
    overscroll-behavior: contain;
  }
  svg {
    position: absolute;
    inset: 0;
    display: block;
    width: 100%;
    height: 100%;
    user-select: none;
    touch-action: none;
    pointer-events: auto;
    transform: translateZ(0);
    shape-rendering: geometricPrecision;
    text-rendering: optimizeLegibility;
  }
</style>
<body>
<div id="app" tabindex="0">
/Users/christopher/Documents/geomaps/vignettes/geomaps/singapore/sea_gdp.svg
</div>

<script>
(() => {
  const ZOOM_INTENSITY = 0.012; 
  const MIN_W = 80;          

  const app = document.getElementById('app');
  const svg = app.querySelector('svg');
  if (!svg) { console.warn('No <svg> found inside #app.'); return; }

  svg.removeAttribute('width'); svg.removeAttribute('height');
  if (!svg.getAttribute('preserveAspectRatio'))
    svg.setAttribute('preserveAspectRatio', 'xMinYMin meet');

  const getVB = () => svg.getAttribute('viewBox').trim().split(/\s+/).map(Number);
  const setVB = (x,y,w,h) => svg.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
  const [X0,Y0,W0,H0] = getVB();
  const ASPECT = H0 / W0;

  // === Desktop dragging ===
  let dragging=false, lastX=0, lastY=0, pid=null;
  svg.addEventListener('pointerdown', e => {
    dragging=true; lastX=e.clientX; lastY=e.clientY; pid=e.pointerId;
    svg.setPointerCapture(pid); app.focus();
  });
  svg.addEventListener('pointerup',     e => { if (e.pointerId===pid) dragging=false; });
  svg.addEventListener('pointercancel', e => { if (e.pointerId===pid) dragging=false; });
  svg.addEventListener('pointermove', e => {
    if (!dragging) return;
    let [vx,vy,vw,vh] = getVB();
    const sx = vw / app.clientWidth, sy = vh / app.clientHeight;
    let nx = vx - (e.clientX - lastX) * sx;
    let ny = vy - (e.clientY - lastY) * sy;
    setVB(nx, ny, vw, vh); 
    lastX=e.clientX; lastY=e.clientY;
  });

  // === Desktop zoom under cursor ===
  function zoomAt(clientX, clientY, factor) {
    let [vx,vy,vw,vh] = getVB();
    const r = svg.getBoundingClientRect();
    const px = (clientX - r.left) / r.width;
    const py = (clientY - r.top)  / r.height;
    let nw = Math.max(vw / factor, MIN_W);
    let nh = nw * ASPECT;
    let nx = vx + px * (vw - nw);
    let ny = vy + py * (vh - nh);
    setVB(nx, ny, nw, nh);
  }

  function onWheel(e) {
    e.preventDefault();
    const unit = (e.deltaMode===1) ? 16 : (e.deltaMode===2) ? app.clientHeight : 1;
    let [vx,vy,vw,vh] = getVB();

    if (e.ctrlKey) {
      const factor = Math.exp(-e.deltaY * unit * ZOOM_INTENSITY);
      zoomAt(e.clientX, e.clientY, factor);
    } else {
      const sx = vw / app.clientWidth, sy = vh / app.clientHeight;
      let nx = vx + e.deltaX * unit * sx;
      let ny = vy + e.deltaY * unit * sy;
      setVB(nx, ny, vw, vh);  
    }
  }
  window.addEventListener('wheel', onWheel, { passive:false, capture:true });

  svg.addEventListener('dblclick', e => {
    e.preventDefault();
    zoomAt(e.clientX, e.clientY, 1.25);
  }, { passive:false });

  // === Mobile pinch/zoom ===
  let lastTouchDist = null;
  svg.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      lastTouchDist = Math.hypot(dx, dy);
    }
  }, { passive:false });

  svg.addEventListener('touchmove', e => {
    if (e.touches.length === 2 && lastTouchDist !== null) {
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.hypot(dx, dy);
      const factor = dist / lastTouchDist;
      const midX = (e.touches[0].clientX + e.touches[1].clientX)/2;
      const midY = (e.touches[0].clientY + e.touches[1].clientY)/2;
      zoomAt(midX, midY, factor);
      lastTouchDist = dist;
    }
  }, { passive:false });

  svg.addEventListener('touchend', e => {
    if (e.touches.length < 2) lastTouchDist = null;
  }, { passive:false });
})();
</script>
</body>
</html>
